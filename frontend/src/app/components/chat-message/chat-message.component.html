<div class="flex gap-3" [class.justify-end]="isUser" [class.justify-start]="!isUser">

  <!-- AI Avatar -->
  <div *ngIf="!isUser"
    class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center flex-shrink-0 mt-1">
    <span class="text-white text-xs font-bold">AI</span>
  </div>

  <div class="max-w-[80%] flex flex-col gap-2">
    <!-- Bubble -->
    <div class="rounded-2xl px-4 py-3 text-sm leading-relaxed"
      [class.bg-blue-600]="isUser"
      [class.text-white]="isUser"
      [class.rounded-br-sm]="isUser"
      [class.bg-slate-800]="!isUser"
      [class.text-slate-200]="!isUser"
      [class.border]="!isUser"
      [class.border-slate-700]="!isUser"
      [class.rounded-bl-sm]="!isUser">

      <!-- User: plain text -->
      <p *ngIf="isUser">{{ message.content }}</p>

      <!-- AI: markdown rendered -->
      <div *ngIf="!isUser" class="prose prose-sm prose-invert max-w-none"
        [innerHTML]="parsedContent">
      </div>
    </div>

    <!-- Sources toggle -->
    <ng-container *ngIf="!isUser && message.sources && message.sources.length > 0">
      <button (click)="toggleSources()"
        class="flex items-center gap-1.5 text-xs text-slate-400 hover:text-blue-400 transition-colors w-fit">
        <svg class="w-3 h-3 transition-transform" [class.rotate-90]="showSources" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd"
            d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
            clip-rule="evenodd"/>
        </svg>
        {{ message.sources!.length }} source chunk{{ message.sources!.length > 1 ? 's' : '' }} used
      </button>

      <div *ngIf="showSources" class="flex flex-col gap-2">
        <div *ngFor="let src of message.sources"
          class="bg-slate-900/60 border border-slate-700/40 rounded-lg p-3">
          <div class="flex items-center gap-2 mb-1.5">
            <svg class="w-3 h-3 text-red-400" fill="currentColor" viewBox="0 0 24 24">
              <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6zm4 18H6V4h7v5h5v11z"/>
            </svg>
            <span class="text-slate-400 text-xs font-medium">{{ src.source }}</span>
          </div>
          <p class="text-slate-500 text-xs leading-relaxed line-clamp-3">{{ src.content }}</p>
        </div>
      </div>
    </ng-container>
  </div>

  <!-- User Avatar -->
  <div *ngIf="isUser"
    class="w-8 h-8 rounded-full bg-slate-600 flex items-center justify-center flex-shrink-0 mt-1">
    <svg class="w-4 h-4 text-slate-300" fill="currentColor" viewBox="0 0 24 24">
      <path d="M12 12c2.7 0 4.8-2.1 4.8-4.8S14.7 2.4 12 2.4 7.2 4.5 7.2 7.2 9.3 12 12 12zm0 2.4c-3.2 0-9.6 1.6-9.6 4.8v2.4h19.2v-2.4c0-3.2-6.4-4.8-9.6-4.8z"/>
    </svg>
  </div>

</div>
